# T004 - Add Row Auto-Conversion to Encrypted Push

**Type**: BE
**State**: pending
**Phase**: Phase A - Server Correctness

## Business Summary
Auto-convert existing plaintext rows to encrypted when pushed via encrypted endpoint, enabling vault enable flow.

## Logic
When updating an existing record in encrypted push, flip `encrypted=true` and clear `data`. This handles the case where a row was previously plaintext but is now being pushed as encrypted.

## Technical Logic

### Changes Required

**UPDATE statement in `/api/sync/push/route.ts`**:
```typescript
// Combined with T002 fix:
UPDATE records
SET
  ciphertext = $1,        -- Set encrypted ciphertext
  encrypted = true,       -- Ensure encrypted flag is true
  data = NULL,            -- Clear data column
  version = version + 1,
  deleted = $2,
  updated_at = NOW()
WHERE id = $3
```

This UPDATE will:
1. Convert a plaintext row to encrypted (flip flag, clear data)
2. Set/update the encrypted ciphertext
3. Increment version

## Testing
Backend test:
1. Insert plaintext row (`encrypted=false`, `data='{}'`, `ciphertext=NULL`)
2. Push via encrypted endpoint with same `recordId`
3. Verify: `encrypted=true`, `data=NULL`, `ciphertext=<new value>`

## Files
- **Modify**: `app/api/sync/push/route.ts`

## Patterns
- Depends on T002 (should implement together)
- Reference T003 for plaintext counterpart

## Dependencies
- T002 (implement together for consistency)

## Notes
This enables the vault enable flow to work - existing plaintext data can be encrypted and pushed.
