# T008 - Add `decryptAndApplyPulledE2eRecords(vaultKey)` Utility

**Type**: FE
**State**: pending
**Phase**: Phase B - Client E2E Pull/Apply Pipeline

## Business Summary
Decrypt pulled ciphertext and apply it into the normal bookmark/space/pinned-view storages.

## Logic
Background pull stores ciphertext locally. When the vault is unlocked (vaultKey available), we decrypt these stored ciphertext records and apply them to the app’s normal storages so the UI reflects cloud state.

## Technical Logic
- New file `lib/decrypt-and-apply.ts` exports `decryptAndApplyPulledE2eRecords(vaultKey: Uint8Array)`.
- Reads stored pulled ciphertext records (from T007 storage additions).
- Decrypts each record using existing crypto helpers (same primitives used by `hooks/useVaultUnlock.ts`).
- Applies per recordType:
  - `bookmark` → `lib/storage.ts`
  - `space` → `lib/spacesStorage.ts`
  - `pinned-view` → `lib/pinnedViewsStorage.ts`
- Must handle `deleted=true` by removing from storage.
- Must set local `_syncVersion = record.version` and `updatedAt = record.updatedAt` (server is source of truth).

## Testing
Jest unit test options:
- Preferred: mock the crypto decrypt function and return JSON.
- Verify correctly updates storages and respects deletes.

## Files
- **Create**: `lib/decrypt-and-apply.ts`

## Patterns
- Reference crypto usage in `hooks/useVaultUnlock.ts`.
- Reference storage merge patterns in `hooks/useSyncEngineUnified.ts` plaintext apply.

## Dependencies
- T007 (ciphertext persistence)
