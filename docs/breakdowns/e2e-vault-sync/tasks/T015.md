# T012 - Add Blocked Sync Dialog (Revert / Delete / Cancel)

**Type**: FE
**State**: pending
**Phase**: Phase C - Mode Switching Safety

## Business Summary
Create UI component showing blocked sync recovery options (revert, delete, cancel).

## Logic
Dialog shows explanation + 3 actions: Revert (useVaultDisable), Delete encrypted, Cancel. Uses existing modal patterns.

## Technical Logic

### New File: `components/sync/BlockedSyncDialog.tsx`

```typescript
'use client';

import { useCallback } from 'react';
import { toast } from 'sonner';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { useVaultDisable } from '@/hooks/useVaultDisable';

interface BlockedSyncDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  onResolved?: () => void;
}

export function BlockedSyncDialog({ open, onOpenChange, onResolved }: BlockedSyncDialogProps) {
  const { disableVault: revertToPlaintext, isDisabling } = useVaultDisable();

  const handleRevert = useCallback(async () => {
    try {
      // useVaultDisable handles: verify passphrase, decrypt, upload plaintext, delete encrypted
      const result = await revertToPlaintext();
      if (result.success) {
        toast.success('Successfully reverted to plaintext mode');
        onResolved?.();
        onOpenChange(false);
      } else {
        toast.error('Revert failed', { description: result.error });
      }
    } catch (error) {
      toast.error('Revert failed', { description: error instanceof Error ? error.message : 'Unknown error' });
    }
  }, [revertToPlaintext, onResolved, onOpenChange]);

  const handleDelete = useCallback(async () => {
    if (!confirm('Are you sure? This will permanently delete your encrypted cloud data without decrypting it. This action cannot be undone.')) {
      return;
    }

    try {
      const response = await fetch('/api/vault/disable', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'delete-encrypted' }),
      });

      if (!response.ok) {
        throw new Error('Failed to delete encrypted data');
      }

      toast.success('Encrypted cloud data deleted');
      onResolved?.();
      onOpenChange(false);
    } catch (error) {
      toast.error('Delete failed', { description: error instanceof Error ? error.message : 'Unknown error' });
    }
  }, [onResolved, onOpenChange]);

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Sync Blocked</DialogTitle>
          <DialogDescription>
            Encrypted cloud data exists from a previous vault session. Plaintext sync is paused to avoid split-brain data.
          </DialogDescription>
        </DialogHeader>

        <div className="py-4">
          <p className="text-sm text-muted-foreground mb-4">
            Choose how to resolve this:
          </p>
          <ul className="text-sm text-muted-foreground space-y-2">
            <li>• <strong>Revert (Recommended)</strong>: Enter your vault passphrase to decrypt and convert data back to plaintext</li>
            <li>• <strong>Delete encrypted data</strong>: Permanently delete encrypted cloud data (dangerous)</li>
          </ul>
        </div>

        <DialogFooter className="flex-col sm:flex-row gap-2">
          <Button
            variant="outline"
            onClick={() => onOpenChange(false)}
            disabled={isDisabling}
          >
            Cancel
          </Button>
          <Button
            variant="destructive"
            onClick={handleDelete}
            disabled={isDisabling}
          >
            Delete Encrypted Data
          </Button>
          <Button
            onClick={handleRevert}
            disabled={isDisabling}
          >
            Revert to Plaintext
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
```

## Testing
FE test:
1. Render dialog with `open=true`
2. Verify all 3 buttons present
3. Click "Delete" - confirm API called, verify confirm dialog shown
4. Click "Revert" - verify `useVaultDisable` called
5. Click "Cancel" - verify `onOpenChange(false)` called

## Files
- **Create**: `components/sync/BlockedSyncDialog.tsx`

## Patterns
- Reference `components/ui/dialog` for Dialog component
- Reference `components/vault/UnlockScreen.tsx` for similar vault interaction pattern
- Reference `hooks/useVaultDisable.ts` for revert logic

## Dependencies
- T016 (delete endpoint must exist)
- Existing `useVaultDisable` hook for revert

## Notes
This implements the "Prompt user" decision - user must choose an action to resolve the block.
