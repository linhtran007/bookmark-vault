# T014 - Route Handler Tests for Push Invariants + Auto-Conversion

**Type**: BE-TEST
**State**: pending
**Phase**: Phase D - Tests

## Business Summary
Test mode invariants and auto-conversion for both push endpoints, ensuring data integrity.

## Logic
Test suite covering: insert with correct mode, update mode conversion, conflict handling for both plaintext and encrypted push.

## Technical Logic

### New File: `__tests__/api/sync/plaintext/push.test.ts`

```typescript
import { POST } from '@/app/api/sync/plaintext/push/route';
import { query } from '@/lib/db';

// Mock auth and db
jest.mock('@clerk/nextjs/server');
jest.mock('@/lib/db');

describe('POST /api/sync/plaintext/push', () => {
  beforeEach(() => {
    jest.clearAllMocks();
  });

  describe('mode invariants', () => {
    it('should set encrypted=false and ciphertext=NULL on insert', async () => {
      // Setup mock to return no existing record
      (query as jest.Mock).mockResolvedValueOnce([]);

      const request = new Request('http://localhost', {
        method: 'POST',
        body: JSON.stringify({
          operations: [{
            recordId: 'test-1',
            recordType: 'bookmark',
            data: { title: 'Test' },
            baseVersion: 0,
            deleted: false,
          }],
        }),
      });

      const response = await POST(request);
      const result = await response.json();

      expect(response.ok).toBe(true);
      expect(query).toHaveBeenCalledWith(
        expect.stringContaining('INSERT INTO records'),
        expect.arrayContaining([
          expect.any(String), // userId
          'test-1',           // recordId
          'bookmark',         // recordType
          expect.any(String), // data (JSON)
          expect.null,        // ciphertext (should be NULL)
          1,                  // version
          false               // deleted
        ])
      );
    });

    it('should clear ciphertext on update', async () => {
      // Setup mock to return existing encrypted record
      (query as jest.Mock).mockResolvedValueOnce([[{
        id: 1,
        version: 1,
        data: null,
        ciphertext: Buffer.from('encrypted'),
      }]]);

      // ... similar test for update path

      expect(query).toHaveBeenCalledWith(
        expect.stringContaining('UPDATE records'),
        expect.arrayContaining([
          expect.any(String), // data
          false,              // encrypted
          null,               // ciphertext
          expect.any(Number), // id
        ])
      );
    });
  });

  describe('auto-conversion', () => {
    it('should convert encrypted row to plaintext', async () => {
      // Setup: existing encrypted record
      (query as jest.Mock).mockResolvedValueOnce([[{
        id: 1,
        version: 1,
        encrypted: true,
        data: null,
        ciphertext: Buffer.from('encrypted'),
      }]]);

      // Push plaintext data
      // ... send request ...

      // Verify: UPDATE flips encrypted=false, clears ciphertext
      expect(query).toHaveBeenCalledWith(
        expect.stringContaining('UPDATE'),
        expect.arrayContaining([
          expect.any(String), // data
          false,              // encrypted
          null,               // ciphertext
          expect.any(Number), // id
        ])
      );
    });
  });
});
```

### New File: `__tests__/api/sync/push.test.ts`

```typescript
import { POST } from '@/app/api/sync/push/route';

// Similar structure for encrypted endpoint

describe('POST /api/sync/push', () => {
  describe('mode invariants', () => {
    it('should set encrypted=true and data=NULL on insert', async () => {
      // ... test that data is NULL on insert
    });

    it('should clear data on update', async () => {
      // ... test that data is NULL on update
    });
  });

  describe('auto-conversion', () => {
    it('should convert plaintext row to encrypted', async () => {
      // Setup: existing plaintext record
      // Push encrypted ciphertext
      // Verify: UPDATE flips encrypted=true, clears data
    });
  });

  describe('conflicts', () => {
    it('should return 409 on version mismatch', async () => {
      // ... test conflict response
    });
  });
});
```

## Testing
Backend tests (self-referential):
1. Run `npm test` or `jest`
2. All tests pass
3. Coverage reports show >80% for push endpoints

## Files
- **Create**: `__tests__/api/sync/plaintext/push.test.ts`
- **Create**: `__tests__/api/sync/push.test.ts`

## Patterns
- Reference existing test patterns in codebase (if any)
- Use jest.mock for external dependencies
- Follow AAA pattern (Arrange, Act, Assert)

## Dependencies
- T001-T004 must be implemented first

## Notes
These tests ensure the mode invariant fixes (T001-T004) are working correctly.
