# T006 - Return Pulled Records from `lib/sync-engine.ts`

**Type**: FE
**State**: pending
**Phase**: Phase B - Encrypted Pull/Apply Pipeline

## Business Summary
Make encrypted sync pull return actual records instead of broadcasting only, enabling client-side apply logic.

## Logic
Modify `syncPull` in `lib/sync-engine.ts` to accumulate and return records array instead of always returning empty array.

## Technical Logic

### Current Issue
Lines 138-143 return empty `records: []` after broadcasting.

### Changes Required

**In `lib/sync-engine.ts`**:

```typescript
// Before (line 111-144):
export async function syncPull(onProgress?: (records: number, hasMore: boolean) => void): Promise<PullResult> {
  // ... existing loop ...
  for (const record of result.records) {
    // Broadcast only
    if (typeof window !== 'undefined' && 'BroadcastChannel' in window) {
      const channel = new BroadcastChannel('vault-sync');
      channel.postMessage({ type: 'RECORD_RECEIVED', record });
    }
  }
  // ...

  return {
    success: true,
    records: [],  // <-- Always empty!
    nextCursor: null,
    hasMore: false,
  };
}

// After:
export async function syncPull(onProgress?: (records: number, hasMore: boolean) => void): Promise<PullResult> {
  let cursor: string | undefined;
  let totalRecords = 0;
  let hasMore = true;
  const allRecords: Array<{ recordId: string; ciphertext: string; version: number; deleted: boolean; updatedAt: string }> = [];

  while (hasMore) {
    const result = await pullRecords(cursor);
    if (!result.success) {
      return { ...result, error: result.error };
    }

    // Accumulate records
    allRecords.push(...result.records);

    // Optional: keep broadcast for backward compatibility
    for (const record of result.records) {
      if (typeof window !== 'undefined' && 'BroadcastChannel' in window) {
        const channel = new BroadcastChannel('vault-sync');
        channel.postMessage({ type: 'RECORD_RECEIVED', record });
      }
    }

    totalRecords += result.records.length;
    hasMore = result.hasMore;
    cursor = result.nextCursor || undefined;

    if (onProgress) {
      onProgress(totalRecords, hasMore);
    }
  }

  return {
    success: true,
    records: allRecords,  // <-- Return accumulated records!
    nextCursor: null,
    hasMore: false,
  };
}
```

## Testing
Backend test:
1. Mock fetch to return test records
2. Call `syncPull()`
3. Assert `result.records` contains expected records
4. Assert `result.records.length > 0`

## Files
- **Modify**: `lib/sync-engine.ts`

## Patterns
- Reference existing `PullResult` interface (lines 10-16)
- Reference `lib/plaintext-sync-engine.ts` pull pattern for comparison

## Dependencies
- None (can implement independently)

## Notes
This is a critical change - without it, E2E pull cannot work. The broadcast pattern can remain for backward compatibility.
