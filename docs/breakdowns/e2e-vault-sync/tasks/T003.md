# T003 - Add Row Auto-Conversion to Plaintext Push

**Type**: BE
**State**: pending
**Phase**: Phase A - Server Correctness

## Business Summary
Auto-convert existing encrypted rows to plaintext when pushed via plaintext endpoint, ensuring mode switching safety.

## Logic
When updating an existing record in plaintext push, flip `encrypted=false` and clear `ciphertext`. This handles the case where a row was previously encrypted but is now being pushed as plaintext.

## Technical Logic

### Changes Required

**UPDATE statement in `/api/sync/plaintext/push/route.ts`**:
```typescript
// Combined with T001 fix:
UPDATE records
SET
  data = $1,              -- Set plaintext data
  encrypted = false,      -- Ensure encrypted flag is false
  ciphertext = NULL,      -- Clear ciphertext column
  version = version + 1,
  deleted = $2,
  updated_at = NOW()
WHERE id = $3
```

This UPDATE will:
1. Convert an encrypted row to plaintext (flip flag, clear ciphertext)
2. Set/update the plaintext data
3. Increment version

## Testing
Backend test:
1. Insert encrypted row (`encrypted=true`, `ciphertext='...'`, `data=NULL`)
2. Push via plaintext endpoint with same `recordId`
3. Verify: `encrypted=false`, `ciphertext=NULL`, `data=<new value>`

## Files
- **Modify**: `app/api/sync/plaintext/push/route.ts`

## Patterns
- Depends on T001 (should implement together)
- Reference T004 for encrypted counterpart

## Dependencies
- T001 (implement together for consistency)

## Notes
This implements the "Auto-convert" user decision - rows can be converted in-place by pushing via different endpoint.
