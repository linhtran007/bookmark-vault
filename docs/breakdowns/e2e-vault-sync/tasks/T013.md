# T013 - Create Hook for Decryption on Vault Unlock

**Type**: FE
**State**: pending
**Phase**: Phase B - Encrypted Pull/Apply Pipeline

## Business Summary
Trigger decryption/apply when user unlocks vault, handling the "background pull" scenario where records were pulled while vault was locked.

## Logic
In `useVaultUnlock.ts`, after successful unlock, decrypt and apply stored ciphertext records.

## Technical Logic

### Changes Required

**In `hooks/useVaultUnlock.ts`**:

Find the unlock success location (where `vaultKey` is set) and add decryption:

```typescript
import { decryptAndApplyRecords } from '@/lib/decrypt-and-apply';

// In the unlock function, after successful key derivation:
export function useVaultUnlock() {
  // ... existing code ...

  const unlock = useCallback(async (passphrase: string) => {
    try {
      // ... existing envelope unwrap logic ...

      // After successful unlock:
      // 1. Set vault key in session (existing)
      sessionStorage.setItem('vaultKey', derivedKey);
      setVaultKey(derivedKey);
      setIsUnlocked(true);

      // 2. Decrypt and apply any pending encrypted records (NEW)
      const applyResult = await decryptAndApplyRecords(derivedKey);
      if (applyResult.success) {
        if (applyResult.applied > 0) {
          toast.success(`Synced ${applyResult.applied} records from cloud`);
        }
      } else {
        console.error('Failed to apply encrypted records:', applyResult.errors);
        toast.error('Some cloud records failed to load', {
          description: applyResult.errors.join(', ')
        });
      }

      return { success: true };
    } catch (error) {
      // ... existing error handling ...
    }
  }, [/* existing deps */]);

  // ... rest of hook ...
}
```

## Testing
FE test:
1. Mock encrypted storage with test records
2. Mock `decryptAndApplyRecords` to return success
3. Call `unlock('test-passphrase')`
4. Verify `decryptAndApplyRecords` called with derived key
5. Verify toast shown for applied records

## Files
- **Modify**: `hooks/useVaultUnlock.ts`

## Patterns
- Reference T011 for decryptAndApply API
- Follow existing toast pattern in file

## Dependencies
- T011 (decryptAndApply function)
- Existing unlock flow must work

## Notes
This completes the "background pull" feature - records pulled while locked are decrypted and applied on unlock.
